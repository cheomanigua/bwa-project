{{ define "main" }}
  <section class="register-section">
    <h1 class="tc mb3">{{ .Title }}</h1>

    <!-- Custom Message Box for Passwords -->
    <div id="password-error-message" class="bg-light-red white pa2 br2 mb3 dn">
        Passwords do not match. Please try again.
    </div>

    <form class="register-form" action="/api/register" method="POST">
      <div class="form-group">
        <label for="name">Full Name</label>
        <input id="name" type="text" placeholder="John Doe" required />
      </div>

      <div class="form-group">
        <label for="email">Email</label>
        <input id="email" type="email" name="email" placeholder="you@example.com" required />
      </div>

      <div class="form-group">
        <label for="password">Password</label>
        <input id="password" type="password" name="password" placeholder="********" required />
      </div>

      <div class="form-group">
        <label for="confirm-password">Confirm Password</label>
        <input id="confirm-password" type="password"  placeholder="********" required />
      </div>

      <div class="form-group">
        <label for="subscription">Choose Subscription</label>
        <select name="plan" id="subscription">
          <option value="basic">Basic - $9/mo</option>
          <option value="pro">Pro - $19/mo</option>
          <option value="elite">Elite - $49/mo</option>
        </select>
      </div>

      <button type="submit" class="grow bg-blue b white pa3 br2 bn pointer w-100">Register</button>
    </form>


		<script>
// Handle registration via JS instead of native form submit
document.querySelector('form').addEventListener('submit', async function(e) {
    e.preventDefault();  // <--- ALWAYS prevent default navigation!

    const pass = document.getElementById('password').value;
    const confirm = document.getElementById('confirm-password').value;
    const email = document.getElementById('email').value;
    const plan = document.getElementById('subscription').value;
    const name = document.getElementById('name').value;

    const errorMessage = document.getElementById('password-error-message');

    // 1. Validate passwords
    if (pass !== confirm) {
        errorMessage.style.display = 'block';
        setTimeout(() => { errorMessage.style.display = 'none'; }, 5000);
        return;
    }

    // Hide old errors
    errorMessage.style.display = 'none';

    // 2. Send register request to backend
    const res = await fetch('/api/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `email=${encodeURIComponent(email)}&password=${encodeURIComponent(pass)}&plan=${encodeURIComponent(plan)}`
    });

    if (!res.ok) {
        alert("Registration failed: " + await res.text());
        return;
    }

    // 3. Auto-login using Firebase Auth
    try {
        await firebase.auth().signInWithEmailAndPassword(email, pass);
    } catch (err) {
        alert("Registered but login failed: " + err.message);
        return;
    }

    // 4. Redirect home
    window.location.href = "/";
});

// Select plan from URL
document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const plan = urlParams.get('plan');
    const select = document.getElementById('subscription');

    if (plan && select) {
        select.value = plan;
    } else if (select) {
        select.value = 'pro';
    }
});
</script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script>
firebase.initializeApp({ apiKey: "fake-api-key", authDomain: "localhost" });
firebase.auth().useEmulator("http://localhost:9099");
</script>





    <p class="mt2 login-cta">
      Already have an account? 
      <a href="/login" class="login-link">Login here</a>
    </p>
  </section>
{{ end }}
