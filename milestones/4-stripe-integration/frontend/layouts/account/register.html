{{ define "main" }}
<section class="register-section">
  <h1 class="tc mb3">{{ .Title }}</h1>

  <!-- Custom Message Box for Passwords -->
  <div id="password-error-message" class="bg-light-red white pa2 br2 mb3 dn">
    Passwords do not match. Please try again.
  </div>

  <form id="register-form" class="register-form">
    <div class="form-group">
      <label for="name">Full Name</label>
      <input
        id="name"
        name="name"
        type="text"
        placeholder="John Doe"
        required
      />
    </div>

    <div class="form-group">
      <label for="email">Email</label>
      <input
        id="email"
        type="email"
        name="email"
        placeholder="you@example.com"
        required
      />
    </div>

    <div class="form-group">
      <label for="password">Password</label>
      <input
        id="password"
        type="password"
        name="password"
        placeholder="********"
        required
      />
    </div>

    <div class="form-group">
      <label for="confirm-password">Confirm Password</label>
      <input
        id="confirm-password"
        type="password"
        name="confirm-password"
        placeholder="********"
        required
      />
    </div>

    <div class="form-group">
      <label for="subscription">Choose Subscription</label>
      <select name="plan" id="subscription">
        <option value="basic">Basic - $9/mo</option>
        <option value="pro">Pro - $19/mo</option>
        <option value="elite">Elite - $49/mo</option>
      </select>
    </div>

    <button type="submit" class="grow bg-blue b white pa3 br2 bn pointer w-100">
      Register
    </button>
    <p id="registerMessage" style="color: green"></p>
  </form>
  <p class="mt2 login-cta">
    Already have an account?
    <a href="/login" class="login-link">Login here</a>
  </p>
</section>


<script type="module">
  // --- REAL Firebase SDK Imports ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
	import { updateNavVisibility } from '{{ "/js/auth.js" | absURL }}'; // Menu visibility logic
  import {
    getAuth,
    connectAuthEmulator,
    // CRITICAL: Use the function for creating a new user
    createUserWithEmailAndPassword, 
  } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

  // NOTE: Config must match your Firebase project setup (usually found in auth_init.html)
  const firebaseConfig = {
    apiKey: "AIzaSy...",
    authDomain: "my-test-project.firebaseapp.com",
    projectId: "my-test-project",
  };

  // Initialize app and auth
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // CRITICAL: Point the client SDK to the Auth Emulator (http://localhost:9099)
  connectAuthEmulator(auth, "http://localhost:9099");

  // Get elements and set up event listener
  document
    .getElementById("register-form")
    .addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const confirmPassword = document.getElementById("confirm-password").value;
      const name = document.getElementById("name").value;
      const plan = document.getElementById("subscription").value;
      const messageElement = document.getElementById("registerMessage");
      const passwordErrorElement = document.getElementById("password-error-message");

      if (password !== confirmPassword) {
        passwordErrorElement.style.display = "block";
        return;
      }
      passwordErrorElement.style.display = "none";

      messageElement.textContent = "Registering user via Firebase SDK...";

      try {
        // 1. CLIENT-SIDE SDK: Create a new user with the Auth Emulator
        const userCredential = await createUserWithEmailAndPassword( // <-- FIXED LINE
          auth,
          email,
          password,
        );
        const idToken = await userCredential.user.getIdToken();

        // 2. BACKEND API: Send the ID Token to the Go server for full registration
        const registerRes = await fetch("/api/register", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            idToken,
            plan,
            name,
            email,
          }),
        });
        
        // Handle backend registration failure
        if (!registerRes.ok) {
            throw new Error(`Backend registration failed with status ${registerRes.status}`);
        }
        
        // 3. EXCHANGE ID TOKEN FOR BACKEND SESSION COOKIE
        await fetch("/api/sessionLogin", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ idToken }),
        });

        messageElement.textContent = `Success! Welcome, ${userCredential.user.email}. Redirecting to dashboard...`;

        // Redirect to the dashboard
        setTimeout(() => {
          window.location.href = "/dashboard";
        }, 1000);
      } catch (error) {
        // Error handling now catches failed registration issues
        messageElement.textContent = `Registration failed: ${error.message}`;
        messageElement.style.color = "red";
        console.error(error);
      }
    });

  // Select plan from URL
  document.addEventListener("DOMContentLoaded", () => {
    const urlParams = new URLSearchParams(window.location.search);
    const plan = urlParams.get("plan");
    const select = document.getElementById("subscription");

    if (plan && select) {
      select.value = plan;
    } else if (select) {
      select.value = "pro";
    }
    // Update navigation visibility after DOM is loaded
    updateNavVisibility();
  });
</script>
{{ end }}
