{{ define "main" }}
<section class="register-section">
  <h1 class="tc mb3">{{ .Title }}</h1>

  <!-- Custom Message Box for Passwords -->
  <div id="password-error-message" class="bg-light-red white pa2 br2 mb3 dn">
    Passwords do not match. Please try again.
  </div>

  <form
    id="register-form"
    class="register-form"
    action="/api/register"
    method="POST"
  >
    <div class="form-group">
      <label for="name">Full Name</label>
      <input
        id="name"
        name="name"
        type="text"
        placeholder="John Doe"
        required
      />
    </div>

    <div class="form-group">
      <label for="email">Email</label>
      <input
        id="email"
        type="email"
        name="email"
        placeholder="you@example.com"
        required
      />
    </div>

    <div class="form-group">
      <label for="password">Password</label>
      <input
        id="password"
        type="password"
        name="password"
        placeholder="********"
        required
      />
    </div>

    <div class="form-group">
      <label for="confirm-password">Confirm Password</label>
      <input
        id="confirm-password"
        type="password"
        name="confirm-password"
        placeholder="********"
        required
      />
    </div>

    <div class="form-group">
      <label for="subscription">Choose Subscription</label>
      <select name="plan" id="subscription">
        <option value="basic">Basic - $9/mo</option>
        <option value="pro">Pro - $19/mo</option>
        <option value="elite">Elite - $49/mo</option>
      </select>
    </div>

    <button type="submit" class="grow bg-blue b white pa3 br2 bn pointer w-100">
      Register
    </button>
    <p id="registerMessage" style="color: green"></p>
  </form>


<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script>
firebase.initializeApp({ apiKey: "fake-api-key", authDomain: "localhost" });
firebase.auth().useEmulator("http://localhost:9099");
</script>

  <script type="module">
    // --- REAL Firebase SDK Imports ---
    // Using CDN links to load the real Firebase modules (must be accessible by the browser)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      connectAuthEmulator,
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

    // NOTE: Config is for the SDK structure.
    const firebaseConfig = {
      apiKey: "AIzaSy...",
      authDomain: "my-test-project.firebaseapp.com",
      projectId: "my-test-project",
    };

    // Initialize app and auth
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // CRITICAL FIX: Point the client SDK to the Auth Emulator running on localhost:9099
    connectAuthEmulator(auth, "http://localhost:9099");

    document.addEventListener("DOMContentLoaded", async () => {
      // Load the navigation HTML first and WAIT for it.
      await loadNavbar();
      // Update visibility after injection
      updateNavVisibility();
    });

    document
      .getElementById("register-form")
      .addEventListener("submit", async (e) => {
        e.preventDefault();

        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const confirm = document.getElementById("confirm-password").value;
        const plan = document.getElementById("subscription").value;
        const name = document.getElementById("name").value;
        const messageElement = document.getElementById("registerMessage");
        messageElement.textContent = "1/2: Creating user profile via Go API...";

        const errorMessage = document.getElementById("password-error-message");

        // 1. Validate passwords
        if (password !== confirm) {
          errorMessage.style.display = "block";
          setTimeout(() => {
            errorMessage.style.display = "none";
          }, 5000);
          return;
        }

        // Hide old errors
        errorMessage.style.display = "none";

        try {
          // 1. CALL GO API: Create user via Admin SDK (Auth & Firestore Emulators)
          //const apiResponse = await fetch('http://localhost:8081/api/register', {
          const apiResponse = await fetch("/api/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password, plan, name }),
          });

          const apiData = await apiResponse.json();

          if (!apiResponse.ok) {
            messageElement.textContent = `API Error: ${apiData.message || apiData.error}`;
            messageElement.style.color = "red";
            return;
          }

          messageElement.textContent = `2/2: User created successfully. Signing in to retrieve token...`;

          // 2. CLIENT-SIDE SDK: Sign in to get the ID Token from the Auth Emulator
          const userCredential = await signInWithEmailAndPassword(
            auth,
            email,
            password,
          );
          const idToken = await userCredential.user.getIdToken();

          // 3. Store the token for future API calls
          localStorage.setItem("id_token", idToken);

          messageElement.textContent = `Success! Welcome, ${userCredential.user.email}. Redirecting to home...`;

          // Redirect to the home page now that the user is logged in.
          setTimeout(() => {
            window.location.href = "index.html";
          }, 2000);
        } catch (error) {
          // Error handling now catches failed sign-in issues
          messageElement.textContent = `Registration failed: ${error.message}`;
          messageElement.style.color = "red";
          console.error(error);
        }
      });

    // Select plan from URL
    document.addEventListener("DOMContentLoaded", () => {
      const urlParams = new URLSearchParams(window.location.search);
      const plan = urlParams.get("plan");
      const select = document.getElementById("subscription");

      if (plan && select) {
        select.value = plan;
      } else if (select) {
        select.value = "pro";
      }
    });
  </script>

  <p class="mt2 login-cta">
    Already have an account?
    <a href="/login" class="login-link">Login here</a>
  </p>
</section>
{{ end }}
