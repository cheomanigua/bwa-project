{{ define "main" }}
<section class="dashboard-section">
  <h1 class="tc mb3">{{ .Title }}</h1>

  <div class="dashboard-card">
    <h2 class="f4 b mb2">Account Information</h2>
    <ul class="dashboard-info">
      <li><strong>Name:</strong> <span id="user-name">Loading...</span></li>
      <li><strong>Email:</strong> <span id="user-email">Loading...</span></li>
      <li><strong>Current Plan:</strong> <span id="user-plan">Loading...</span></li>
      <li>
        <strong>Subscription Created:</strong>
        <span id="user-created">Loading...</span>
      </li>
      <li>
        <strong>Next Renewal:</strong>
        <span id="user-next-renewal">Loading...</span>
      </li>
    </ul>
  </div>

  <div class="dashboard-actions">
    <h2 class="f4 b mb2">Manage Subscription</h2>
    <p class="mb2">
      You will be securely redirected to the Stripe Customer Portal to update
      payment details, change plans, and view billing history.
    </p>
    <div class="btn-group">
      <button
        class="grow bg-blue white pa3 br2 bn pointer"
        onclick="openCustomerPortal()"
      >
        Manage Subscription & Billing
      </button>
    </div>
  </div>

  <div class="dashboard-actions">
    <h2 class="f4 b mb2">Account Settings</h2>
    <div class="btn-group">
      <button
        class="grow bg-dark-red white pa3 br2 bn pointer"
        onclick="deleteAccount()"
      >
        Delete Account
      </button>

      <button 
        class="grow bg-orange white pa3 br2 bn pointer"
        onclick="togglePasswordForm()"
      >
        Change Password
      </button>

      <button class="grow bg-gray white pa3 br2 bn pointer">
        Contact Support
      </button>
    </div>

    <div id="change-password-container" class="dn mt3 pa3 ba b--light-gray br2 bg-near-white">
      <form id="password-form" hx-post="/api/change-password" hx-target="#password-feedback">
        <div class="mb3">
          <label class="db fw6 lh-copy f6" for="new-password">New Password</label>
          <input class="pa2 input-reset ba bg-transparent w-100" type="password" name="newPassword" id="new-password" required minlength="6">
        </div>
        <div class="mb3">
          <label class="db fw6 lh-copy f6" for="confirm-password">Confirm New Password</label>
          <input class="pa2 input-reset ba bg-transparent w-100" type="password" id="confirm-password" required minlength="6">
        </div>
        <div class="flex">
          <button class="ph3 pv2 input-reset ba b--black bg-transparent grow pointer f6 dib mr2" type="submit">
            Save New Password
          </button>
          <button class="ph3 pv2 input-reset ba b--black-20 bg-light-gray grow pointer f6 dib" type="button" onclick="togglePasswordForm()">
            Cancel
          </button>
        </div>
        <div id="password-feedback" class="mt2 f6"></div>
      </form>
    </div>
  </div>
</section>

<script>
  // --- 1. SESSION DATA & UI POPULATION ---
  document.addEventListener("DOMContentLoaded", async () => {
    try {
      const response = await fetch("/api/session");
      const userData = await response.json();

      if (userData.loggedIn) {
        document.getElementById("user-name").textContent = userData.name || "N/A";
        document.getElementById("user-email").textContent = userData.email || "N/A";
        document.getElementById("user-plan").textContent = userData.plan ? capitalize(userData.plan) : "N/A";
        document.getElementById("user-created").textContent = userData.registeredAt || "N/A";
        document.getElementById("user-next-renewal").textContent = userData.nextRenewal || "N/A";
      } else {
        window.location.href = "/login";
      }
    } catch (error) {
      console.error("Failed to fetch user data:", error);
    }
  });

  function capitalize(s) {
    if (typeof s !== "string") return "";
    return s.charAt(0).toUpperCase() + s.slice(1);
  }

  // --- 2. CHANGE PASSWORD LOGIC (HTMX) ---
  function togglePasswordForm() {
    const container = document.getElementById('change-password-container');
    const form = document.getElementById('password-form');
    const feedback = document.getElementById('password-feedback');
    
    container.classList.toggle('dn');
    if (container.classList.contains('dn')) {
        form.reset();
        feedback.innerHTML = "";
    }
  }

  // Intercept HTMX request for double-input validation
  document.body.addEventListener('htmx:configRequest', function(evt) {
    if (evt.detail.elt.id === 'password-form') {
      const p1 = document.getElementById('new-password').value;
      const p2 = document.getElementById('confirm-password').value;
      const fb = document.getElementById('password-feedback');

      if (p1 !== p2) {
        evt.preventDefault(); // Stop the request
        fb.innerHTML = '<span style="color: red;">Passwords do not match.</span>';
      } else {
        fb.innerHTML = '<span style="color: blue;">Processing...</span>';
      }
    }
  });

  // Handle successful password change response
  document.body.addEventListener('htmx:afterOnLoad', function(evt) {
    if (evt.detail.target.id === 'password-feedback') {
        if (evt.detail.xhr.responseText.includes('successfully')) {
            setTimeout(() => { togglePasswordForm(); }, 2000);
        }
    }
  });

  // --- 3. STRIPE & ACCOUNT ACTIONS ---
  async function openCustomerPortal() {
    try {
      const response = await fetch("/api/create-customer-portal-session", { method: "POST" });
      const data = await response.json();
      if (data.url) window.location.href = data.url;
    } catch (error) {
      console.error("Portal error:", error);
    }
  }

  async function deleteAccount() {
    if (!confirm("Are you sure you want to delete your account?")) return;
    try {
      const response = await fetch("/api/delete-account", { method: "POST" });
      if (response.ok) window.location.href = "/";
    } catch (error) {
      console.error("Deletion error:", error);
    }
  }
</script>

{{ end }}
