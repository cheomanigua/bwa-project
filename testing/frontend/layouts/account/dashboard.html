{{ define "main" }}
<section class="dashboard-section">
  <h1 class="tc mb3">{{ .Title }}</h1>

  <div class="dashboard-card">
    <h2 class="f4 b mb2">Account Information</h2>
    <ul class="dashboard-info">
      <li><strong>Name:</strong> <span id="user-name">Jane Doe</span></li>
      <li>
        <strong>Email:</strong> <span id="user-email">jane@example.com</span>
      </li>
      <li><strong>Current Plan:</strong> <span id="user-plan">Pro</span></li>
      <li>
        <strong>Subscription Created:</strong>
        <span id="user-created">Jan 15, 2024</span>
      </li>
      <li>
        <strong>Next Renewal:</strong>
        <span id="user-next-renewal">N/A</span>
      </li>
    </ul>
  </div>

  <div class="dashboard-actions">
    <h2 class="f4 b mb2">Manage Subscription</h2>
    <p class="mb2">
      You will be securely redirected to the Stripe Customer Portal to update
      payment details, change plans, and view billing history.
    </p>
    <div class="btn-group">
      <button
        class="grow bg-blue white pa3 br2 bn pointer"
        onclick="openCustomerPortal()"
      >
        Manage Subscription & Billing
      </button>
    </div>
  </div>

  <div class="dashboard-actions">
    <h2 class="f4 b mb2">Account Settings</h2>
    <div class="btn-group">
      <button
        class="grow bg-dark-red white pa3 br2 bn pointer"
        onclick="deleteAccount()"
      >
        Delete Account
      </button>
      <button class="grow bg-gray white pa3 br2 bn pointer">
        Contact Support
      </button>
    </div>
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    try {
      // 1. Fetch the user session data from the backend
      const response = await fetch("/api/session");
      const userData = await response.json();

      if (userData.loggedIn) {
        // 2. Update the DOM elements with actual user data
        document.getElementById("user-name").textContent =
          userData.name || "N/A";
        document.getElementById("user-email").textContent =
          userData.email || "N/A";

        // Capitalize the plan (e.g., 'basic' -> 'Basic')
        const planText = userData.plan ? capitalize(userData.plan) : "N/A";
        document.getElementById("user-plan").textContent = planText;

        document.getElementById("user-created").textContent =
          userData.registeredAt || "N/A";

        document.getElementById("user-next-renewal").textContent =
          userData.nextRenewal || "N/A";
      } else {
        // If the user is not logged in, redirect to login
        window.location.href = "/login";
      }
    } catch (error) {
      console.error("Failed to fetch user data:", error);
    }
  });

  function capitalize(s) {
    if (typeof s !== "string") return "";
    return s.charAt(0).toUpperCase() + s.slice(1);
  }

  // NEW FUNCTION: Opens the Stripe Customer Portal
  async function openCustomerPortal() {
    try {
      // Call the backend API to create the secure session
      const response = await fetch("/api/create-customer-portal-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });

      if (!response.ok) {
        const errorText = await response.text();
        console.error("Error creating portal session:", errorText);
        alert(
          "Failed to access subscription management. Please ensure you are logged in and have an active subscription.",
        );
        return;
      }

      const data = await response.json();
      if (data.url) {
        // Redirect the user to the Stripe-hosted Customer Portal
        window.location.href = data.url;
      }
    } catch (error) {
      console.error("Network error during portal creation:", error);
      alert("A network error occurred. Please try again.");
    }
  }

  // NEW FUNCTION: Delete user and customer account
  async function deleteAccount() {
    if (
      !confirm(
        "Are you sure you want to delete your account? This action cannot be undone and will cancel any active subscription.",
      )
    ) {
      return;
    }

    try {
      const response = await fetch("/api/delete-account", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });

      if (!response.ok) {
        const errorText = await response.text();
        console.error("Error deleting account:", errorText);
        alert("Failed to delete account. Please try again or contact support.");
        return;
      }

      alert("Your account has been successfully deleted.");
      window.location.href = "/";
    } catch (error) {
      console.error("Network error during account deletion:", error);
      alert("A network error occurred. Please try again.");
    }
  }
</script>

{{ end }}
